import * as React from 'react';
import { useAtom } from 'jotai';
import { useNaverMap } from '@/lib/navermap';
import { getNavermapSDK } from '@/lib/navermap/utils';
import {
  bottomSheetTypeAtom,
  currentBakeryIdAtom,
  bottomSheetRefAtom,
  currentFilterAtom,
} from './store';
import type { BakeryEntity, Bread } from './types';

const DEFAULT_BREAD_ICON =
  '<svg class="bread-marker__item" viewBox="0 0 32 36" fill="none" xmlns="http://www.w3.org/2000/svg"><path class="bread-marker__item-background" d="M32 15.5C32 24.0604 20.7075 36 16 36C11.2925 36 0 24.0604 0 15.5C0 6.93959 7.16344 0 16 0C24.8366 0 32 6.93959 32 15.5Z" /><path class="bread-marker__item-content" fill-rule="evenodd" clip-rule="evenodd" d="M14.9708 10.7405C15.1327 10.6433 15.6871 10.4489 16.4825 10.3877C17.0499 10.3441 17.709 10.3712 18.3901 10.536C18.3414 10.612 18.3145 10.6979 18.3096 10.7849C18.187 10.8797 18.0819 10.977 17.9962 11.0716C17.1066 12.0392 16.7647 13.1808 16.7647 14.4169C16.7647 14.7011 16.9951 14.9316 17.2794 14.9316C17.5637 14.9316 17.7941 14.7011 17.7941 14.4169C17.7941 13.3857 18.072 12.5095 18.7552 11.767L18.7584 11.7635C19.0905 11.396 20.0701 10.842 21.2974 11.2664C21.3704 11.2927 21.4429 11.3208 21.5143 11.3508C21.5697 11.3747 21.6254 11.4006 21.6816 11.4287C21.703 11.4394 21.7249 11.4485 21.747 11.456C23.8232 12.4528 25 13.9248 25 15.4463C25 16.7277 24.1673 17.7438 22.587 18.467C21.0033 19.1917 18.7692 19.5639 16.25 19.5639C13.7308 19.5639 11.4967 19.1917 9.91304 18.467C8.33268 17.7438 7.5 16.7277 7.5 15.4463C7.5 13.9114 8.69763 12.4269 10.8081 11.4298C11.3168 11.1894 11.8967 11.0408 12.3947 11.0098C12.5835 10.998 12.7515 11.0038 12.8936 11.0238C12.6468 11.2853 12.4379 11.563 12.2648 11.8568C11.8022 12.6423 11.6176 13.5074 11.6176 14.4169C11.6176 14.7011 11.8481 14.9316 12.1324 14.9316C12.4166 14.9316 12.6471 14.7011 12.6471 14.4169C12.6471 13.6495 12.8015 12.9741 13.1519 12.3792C13.5023 11.7841 14.0697 11.2338 14.9529 10.7508C14.9589 10.7475 14.9649 10.744 14.9708 10.7405Z"/></svg>';
const MEAL_BREAD_ICON =
  '<svg class="bread-marker__item" viewBox="0 0 32 36" fill="none" xmlns="http://www.w3.org/2000/svg"><path class="bread-marker__item-background" d="M32 15.5C32 24.0604 20.7075 36 16 36C11.2925 36 0 24.0604 0 15.5C0 6.93959 7.16344 0 16 0C24.8366 0 32 6.93959 32 15.5Z" fill="${backgroundColour}"/><path class="bread-marker__item-content fill-rule="evenodd" clip-rule="evenodd" d="M23.415 11.7543C23.415 12.6493 23.08 13.4943 22.49 14.2243V21.2543C22.49 22.4043 21.555 23.3393 20.405 23.3393H11.595C10.445 23.3393 9.50996 22.4043 9.50996 21.2543V14.2243C8.91996 13.4943 8.58496 12.6493 8.58496 11.7543C8.58496 8.9393 11.905 6.6543 16 6.6543C20.095 6.6543 23.415 8.9393 23.415 11.7543ZM15.085 13.1543C14.535 13.1543 14.085 13.6043 14.085 14.1543V16.1543C14.085 16.7043 14.535 17.1543 15.085 17.1543H17.085C17.635 17.1543 18.085 16.7043 18.085 16.1543V14.1543C18.085 13.6043 17.635 13.1543 17.085 13.1543H15.085Z"/></svg>';
const BEGAN_KITO_ICON =
  '<svg class="bread-marker__item" viewBox="0 0 32 36" fill="none" xmlns="http://www.w3.org/2000/svg"><path class="bread-marker__item-background" d="M32 15.5C32 24.0604 20.7075 36 16 36C11.2925 36 0 24.0604 0 15.5C0 6.93959 7.16344 0 16 0C24.8366 0 32 6.93959 32 15.5Z"/><path class="bread-marker__item-content" fill-rule="evenodd" clip-rule="evenodd" d="M6 15C6 9.485 10.485 5 16 5C21.515 5 26 9.485 26 15C26 20.515 21.515 25 16 25C10.485 25 6 20.515 6 15ZM10.3 21.96C11.855 23.235 13.84 24 16 24C20.96 24 25 19.96 25 15C25 12.84 24.235 10.855 22.96 9.3L20.52 11.74C20.42 11.835 20.295 11.885 20.165 11.885C20.035 11.885 19.91 11.84 19.81 11.74C19.615 11.545 19.615 11.23 19.81 11.035L22.28 8.565C20.66 6.98 18.445 6 16 6C11.035 6 7 10.035 7 15C7 17.445 7.98 19.66 9.565 21.285L11.755 19.095C11.95 18.9 12.265 18.9 12.46 19.095C12.655 19.29 12.655 19.605 12.46 19.8L10.3 21.96ZM18.1448 9.31H18.1548C18.3098 9.29 18.4698 9.34 18.5848 9.445C18.7048 9.55 18.7748 9.7 18.7748 9.86V16.525C18.7748 17.815 17.8898 18.9 16.6898 19.21V22.08C16.6898 22.465 16.3798 22.775 15.9948 22.775C15.6098 22.775 15.2998 22.465 15.2998 22.08V19.21C14.0998 18.905 13.2148 17.82 13.2148 16.525V9.86C13.2148 9.7 13.2848 9.55 13.4048 9.445C13.5248 9.34 13.6798 9.29 13.8398 9.31H13.8448H13.8548C13.8569 9.31 13.8598 9.31086 13.8633 9.31186C13.8681 9.31328 13.874 9.315 13.8798 9.315C13.8998 9.32 13.9298 9.325 13.9648 9.33C14.0348 9.34 14.1348 9.36 14.2498 9.385C14.4748 9.44 14.7898 9.525 15.1098 9.665C15.1748 9.69 15.2398 9.72 15.3048 9.755V8.695C15.3048 8.31 15.6148 8 15.9998 8C16.3848 8 16.6948 8.31 16.6948 8.695V9.76C16.7598 9.725 16.8298 9.69 16.8898 9.665C17.2048 9.525 17.5198 9.44 17.7498 9.385L17.7648 9.38188C17.8778 9.35834 17.9678 9.33958 18.0348 9.33C18.0558 9.324 18.075 9.3216 18.0914 9.31956C18.1022 9.3182 18.1118 9.317 18.1198 9.315C18.1298 9.31 18.1398 9.31 18.1448 9.31ZM15.9998 17.46C16.2048 17.46 16.3748 17.29 16.3748 17.085V11.25C16.3748 11.045 16.2048 10.875 15.9998 10.875C15.7948 10.875 15.6248 11.045 15.6248 11.25V17.085C15.6248 17.29 15.7948 17.46 15.9998 17.46Z"/></svg>';
const CROISSANT_ICON =
  '<svg class="bread-marker__item" viewBox="0 0 32 36" fill="none" xmlns="http://www.w3.org/2000/svg"><path class="bread-marker__item-background" d="M32 15.5C32 24.0604 20.7075 36 16 36C11.2925 36 0 24.0604 0 15.5C0 6.93959 7.16344 0 16 0C24.8366 0 32 6.93959 32 15.5Z"/><path class="bread-marker__item-content" fill-rule="evenodd" clip-rule="evenodd" d="M20.6676 10.7303C20.3835 8.70928 17.5363 8.61093 15.9859 8.65058C12.2489 8.65058 11.5581 9.60573 11.3264 10.7303C10.9771 13.5227 12.1039 15.7808 13.0886 17.1065C13.531 17.7021 13.9719 18.1621 14.3574 18.1525C14.7513 18.1525 14.9053 18.056 15.0683 17.9537C15.2517 17.8388 15.4465 17.7167 16.0068 17.7167C16.5515 17.7167 16.6991 17.82 16.8513 17.9265C16.9949 18.027 17.1425 18.1303 17.6313 18.1525C18.6383 18.1983 21.3584 13.6706 20.6676 10.7303ZM19.3376 18.0021L19.351 18.0173C19.8651 18.6012 20.2062 18.9887 21.1958 18.899C22.194 18.8086 24.107 17.1188 24.6772 16.0316C25.2474 14.9443 24.6373 13.914 23.9126 13.1893C23.4303 12.707 22.8179 12.3209 22.2116 12.0238C21.9667 11.9038 21.6886 12.0893 21.6707 12.3615C21.5656 13.9586 20.9594 15.9206 19.3376 18.0021ZM12.6944 18.0173L12.7078 18.0021C11.086 15.9206 10.4798 13.9586 10.3747 12.3615C10.3568 12.0893 10.0787 11.9038 9.8338 12.0238C9.22748 12.3209 8.6151 12.707 8.13283 13.1893C7.40806 13.914 6.798 14.9443 7.3682 16.0316C7.9384 17.1188 9.85136 18.8086 10.8495 18.899C11.8392 18.9887 12.1803 18.6012 12.6944 18.0173ZM24.1718 18.2806C23.7379 18.718 23.23 19.0529 22.8723 19.2605C22.6883 19.3673 22.6148 19.5995 22.7367 19.7738C22.9196 20.0353 23.1546 20.3135 23.3608 20.5244C23.7318 20.9041 24.7034 21.4841 25.272 20.5244C25.6406 19.9025 25.4966 18.3335 25.2986 17.4177C25.264 17.2578 25.0582 17.229 24.9627 17.3618C24.7958 17.5936 24.546 17.9034 24.1718 18.2806ZM9.17116 19.2605C8.81345 19.0529 8.30555 18.718 7.87163 18.2806C7.49743 17.9034 7.24762 17.5936 7.08077 17.3618C6.98519 17.229 6.77942 17.2578 6.74485 17.4177C6.54685 18.3335 6.40287 19.9025 6.77141 20.5244C7.34009 21.4841 8.31163 20.9041 8.68267 20.5244C8.88879 20.3135 9.12381 20.0353 9.30671 19.7738C9.42861 19.5995 9.35511 19.3673 9.17116 19.2605Z"/></svg>';
const BAKEDBREAD_ICON =
  '<svg class="bread-marker__item" viewBox="0 0 32 36" fill="none" xmlns="http://www.w3.org/2000/svg"><path class="bread-marker__item-background" d="M32 15.5C32 24.0604 20.7075 36 16 36C11.2925 36 0 24.0604 0 15.5C0 6.93959 7.16344 0 16 0C24.8366 0 32 6.93959 32 15.5Z"/><path class="bread-marker__item-content" fill-rule="evenodd" clip-rule="evenodd" d="M21.8998 9.52539C21.5198 7.54039 19.0248 6.54039 16.0298 6.52539C16.0198 6.52539 16.0098 6.52539 15.9998 6.52539C15.9898 6.52539 15.9798 6.52539 15.9698 6.52539C12.9748 6.54039 10.4798 7.54039 10.0998 9.52539L8.02979 18.7754C8.02979 19.7504 9.00479 20.5954 9.00479 20.5954C9.14979 20.7654 9.25979 20.9954 9.37479 21.2354C9.56479 21.6354 9.76479 22.0654 10.1648 22.2804C10.4498 22.4354 10.8298 22.4104 11.2248 22.3854C11.5648 22.3604 11.9198 22.3404 12.2298 22.4304C12.4998 22.5104 12.7498 22.7054 13.0098 22.9104C13.3248 23.1604 13.6448 23.4104 14.0198 23.4604C14.3498 23.5054 14.6998 23.3604 15.0598 23.2154C15.3698 23.0854 15.6898 22.9604 15.9998 22.9504C16.3148 22.9604 16.6298 23.0854 16.9398 23.2154C17.2948 23.3604 17.6498 23.5054 17.9798 23.4604C18.3548 23.4104 18.6748 23.1554 18.9898 22.9104C19.2448 22.7104 19.4998 22.5104 19.7698 22.4304C20.0848 22.3354 20.4348 22.3604 20.7748 22.3854C21.1698 22.4104 21.5448 22.4354 21.8348 22.2804C22.2348 22.0654 22.4348 21.6354 22.6248 21.2354C22.7398 20.9954 22.8498 20.7604 22.9948 20.5954C22.9948 20.5954 23.9698 19.7504 23.9698 18.7754L21.8998 9.52539ZM12.0448 17.7554C12.0098 17.9354 11.8548 18.0604 11.6748 18.0604C11.6498 18.0604 11.6298 18.0604 11.6048 18.0554C11.3998 18.0154 11.2698 17.8204 11.3048 17.6154L12.0048 13.9304C12.0448 13.7254 12.2398 13.5954 12.4448 13.6304C12.6498 13.6704 12.7798 13.8654 12.7448 14.0704L12.0448 17.7554ZM16.4048 18.8004C16.4048 19.0054 16.2348 19.1754 16.0298 19.1754C15.8248 19.1754 15.6548 19.0054 15.6548 18.8004V14.8004C15.6548 14.5954 15.8248 14.4254 16.0298 14.4254C16.2348 14.4254 16.4048 14.5954 16.4048 14.8004V18.8004ZM16.0298 11.0204C14.6848 11.0204 13.6748 10.4054 13.6748 9.58539C13.6748 9.38039 13.8448 9.21039 14.0498 9.21039C14.2548 9.21039 14.4248 9.38039 14.4248 9.58539C14.4248 9.86539 15.0498 10.2704 16.0298 10.2704C17.0098 10.2704 17.6348 9.86539 17.6348 9.58539C17.6348 9.38039 17.8048 9.21039 18.0098 9.21039C18.2148 9.21039 18.3848 9.38039 18.3848 9.58539C18.3848 10.4054 17.3748 11.0204 16.0298 11.0204ZM20.6248 18.0554C20.5998 18.0604 20.5798 18.0604 20.5548 18.0604C20.3798 18.0604 20.2198 17.9354 20.1848 17.7554L19.4848 14.0704C19.4448 13.8654 19.5798 13.6704 19.7848 13.6304C19.9898 13.5904 20.1848 13.7254 20.2248 13.9304L20.9248 17.6154C20.9598 17.8204 20.8298 18.0154 20.6248 18.0554Z"/></svg>';
const CAKE_ICON =
  '<svg class="bread-marker__item" viewBox="0 0 32 36" fill="none" xmlns="http://www.w3.org/2000/svg"><path class="bread-marker__item-background" d="M32 15.5C32 24.0604 20.7075 36 16 36C11.2925 36 0 24.0604 0 15.5C0 6.93959 7.16344 0 16 0C24.8366 0 32 6.93959 32 15.5Z"/><path class="bread-marker__item-content" fill-rule="evenodd" clip-rule="evenodd" d="M20.2499 10.0154C20.2499 11.0504 19.4099 11.8904 18.3749 11.8904C17.3399 11.8904 16.5049 11.0554 16.5049 10.0204C16.5049 8.98539 17.3449 8.14539 18.3799 8.14539C18.5849 8.14539 18.7799 8.19039 18.9649 8.25039C18.9699 8.01539 19.0349 7.76539 19.1599 7.53039C19.1658 7.51934 19.1717 7.50818 19.1776 7.49696C19.2119 7.43203 19.2473 7.36508 19.2899 7.30539C19.6449 6.81039 20.1949 6.52539 20.7899 6.52539C20.9949 6.52539 21.1649 6.69539 21.1649 6.90039C21.1649 7.10539 20.9949 7.27539 20.7899 7.27539C20.2899 7.27539 19.9999 7.60039 19.8999 7.74039C19.882 7.76189 19.8692 7.78597 19.856 7.81077C19.8508 7.82057 19.8455 7.83048 19.8399 7.84039C19.7249 8.04039 19.6749 8.25039 19.7249 8.40039C19.7599 8.50039 19.7449 8.60539 19.6999 8.69039C20.0399 9.03039 20.2499 9.49539 20.2499 10.0154ZM20.96 10.4013C21.855 11.1063 22.66 11.9513 23.31 12.9113C23.76 13.5813 24 14.3563 24 15.1563V19.9013C24 20.5763 23.495 21.1613 22.82 21.2613L9.58 23.4713C9.51 23.4813 9.44 23.4863 9.375 23.4863C9.045 23.4863 8.725 23.3663 8.475 23.1513C8.175 22.8913 8 22.5113 8 22.1113V18.1863C8 17.0063 8.46 15.9013 9.295 15.0663L14.195 9.53133C14.735 8.92633 15.47 8.56133 16.25 8.48633C16.065 8.74133 15.935 9.02633 15.85 9.33633C15.79 9.55133 15.75 9.77633 15.75 10.0113C15.75 11.4563 16.93 12.6363 18.375 12.6363C19.405 12.6363 20.29 12.0363 20.72 11.1663C20.84 10.9263 20.92 10.6713 20.96 10.4013ZM21.155 14.6163C21.12 14.4113 20.925 14.2763 20.72 14.3113L11.4 15.9863C11.195 16.0213 11.06 16.2163 11.095 16.4213C11.13 16.6063 11.285 16.7313 11.465 16.7313H11.465C11.485 16.7313 11.51 16.7313 11.53 16.7263L20.85 15.0513C21.055 15.0163 21.19 14.8213 21.155 14.6163Z"/></svg>';
const PIE_TART_ICON =
  '<svg class="bread-marker__item" viewBox="0 0 32 36" fill="none" xmlns="http://www.w3.org/2000/svg"><path class="bread-marker__item-background" d="M32 15.5C32 24.0604 20.7075 36 16 36C11.2925 36 0 24.0604 0 15.5C0 6.93959 7.16344 0 16 0C24.8366 0 32 6.93959 32 15.5Z"/><path class="bread-marker__item-content" fill-rule="evenodd" clip-rule="evenodd" d="M24.065 12.4107L24.265 12.5157C24.84 12.8257 24.935 13.5557 24.565 14.0257L22.54 19.1307L22.525 19.1607L22.52 19.1757C21.88 20.6007 19.205 21.6707 16.005 21.6707C12.805 21.6707 10.13 20.6007 9.48997 19.1757L9.48497 19.1607L9.46997 19.1307L7.44497 14.0207C7.07497 13.5607 7.16997 12.8357 7.74497 12.5257L7.94497 12.4157C8.18497 12.2857 8.33997 12.0407 8.34997 11.7707L8.36497 11.4057C8.39997 10.5257 9.24997 9.9207 10.095 10.1657L10.31 10.2307C10.66 10.3357 11.035 10.1757 11.205 9.8557L11.415 9.4657C11.795 8.7607 12.705 8.5357 13.37 8.9907L13.705 9.2207C14.02 9.4357 14.445 9.3857 14.705 9.1057L15.005 8.7807C15.54 8.2007 16.46 8.2007 16.995 8.7807L17.295 9.1057C17.555 9.3857 17.98 9.4357 18.295 9.2207L18.635 8.9907C19.3 8.5357 20.21 8.7557 20.59 9.4657L20.8 9.8557C20.97 10.1757 21.345 10.3307 21.695 10.2307L21.915 10.1657C22.755 9.9157 23.61 10.5257 23.645 11.4057L23.66 11.7657C23.67 12.0357 23.825 12.2807 24.065 12.4107ZM16.92 9.8307C16.645 9.6557 16.335 9.5507 16 9.5507C15.665 9.5507 15.355 9.6557 15.08 9.8307C14.855 9.9707 14.65 10.1607 14.475 10.3807C11.355 10.7007 8.94497 11.9507 8.94497 13.3957C8.94497 15.0707 12.175 16.4857 16 16.4857C19.825 16.4857 23.055 15.0707 23.055 13.3957C23.055 11.9457 20.645 10.6957 17.525 10.3807C17.35 10.1607 17.145 9.9757 16.92 9.8307ZM17.8002 12.4508C17.8002 13.4458 16.9952 14.2508 16.0002 14.2508C15.0052 14.2508 14.2002 13.4458 14.2002 12.4508C14.2002 11.4558 15.0052 10.0508 16.0002 10.0508C16.9952 10.0508 17.8002 11.4558 17.8002 12.4508Z"/></svg>';
const MACARON_ICON =
  '<svg class="bread-marker__item" viewBox="0 0 32 36" fill="none" xmlns="http://www.w3.org/2000/svg"><path class="bread-marker__item-background" d="M32 15.5C32 24.0604 20.7075 36 16 36C11.2925 36 0 24.0604 0 15.5C0 6.93959 7.16344 0 16 0C24.8366 0 32 6.93959 32 15.5Z"/><path class="bread-marker__item-content" fill-rule="evenodd" clip-rule="evenodd" d="M8.26514 12.9103C8.26514 10.5003 10.6601 8.07031 16.0051 8.07031C21.3501 8.07031 23.7451 10.5003 23.7401 12.9103C23.7401 13.6503 23.4551 14.3403 22.9201 14.9353C22.6101 15.2753 22.2201 15.5903 21.7501 15.8553C20.3801 16.6353 18.3951 17.0453 16.0051 17.0453C13.6251 17.0453 11.6401 16.6303 10.2601 15.8553C9.78014 15.5853 9.38514 15.2703 9.07514 14.9253C8.54514 14.3353 8.26514 13.6453 8.26514 12.9103ZM22.4503 17.6152C22.6853 17.3902 22.8803 17.1502 23.0203 16.9102C23.2853 17.2852 23.4303 17.6652 23.4303 18.0552C23.4303 19.1702 22.6453 20.2152 21.2253 20.9952C19.8253 21.7652 17.9703 22.1852 16.0003 22.1852C14.0303 22.1852 12.1753 21.7602 10.7753 20.9952C9.35531 20.2152 8.57031 19.1702 8.57031 18.0552C8.57031 17.6702 8.71031 17.2852 8.97531 16.9102C9.11531 17.1502 9.30531 17.3902 9.54531 17.6152C9.86531 17.9202 10.2703 18.2052 10.7553 18.4602C12.0853 19.1602 13.9353 19.6002 16.0003 19.6002C18.0703 19.6002 19.9153 19.1602 21.2453 18.4602C21.7303 18.2002 22.1303 17.9152 22.4503 17.6152Z"/></svg>';
const DOCUT_ICON =
  '<svg class="bread-marker__item" viewBox="0 0 32 36" fill="none" xmlns="http://www.w3.org/2000/svg"><path class="bread-marker__item-background" d="M32 15.5C32 24.0604 20.7075 36 16 36C11.2925 36 0 24.0604 0 15.5C0 6.93959 7.16344 0 16 0C24.8366 0 32 6.93959 32 15.5Z"/><path class="bread-marker__item-content" d="M24.41 14.35C24.205 14.445 23.985 14.5 23.75 14.5C22.785 14.5 22 13.605 22 12.5C22 12.025 22.15 11.595 22.39 11.255C22.12 11.405 21.82 11.5 21.5 11.5C20.395 11.5 19.5 10.495 19.5 9.25C19.5 8.92 19.565 8.615 19.675 8.33C18.565 7.81 17.32 7.5 16 7.5C11.31 7.5 7.5 11.31 7.5 15.365C7.5 19.42 10.72 23 16 23C21.28 23 24.5 19.42 24.5 15.365C24.5 15.025 24.465 14.685 24.41 14.35ZM16 16.68C14.52 16.68 13.315 15.74 13.315 14.58C13.315 13.42 14.52 12.48 16 12.48C17.48 12.48 18.685 13.42 18.685 14.58C18.685 15.74 17.48 16.68 16 16.68Z"/></svg>';
const COOKIE_ICON =
  '<svg class="bread-marker__item" viewBox="0 0 32 36" fill="none" xmlns="http://www.w3.org/2000/svg"><path class="bread-marker__item-background" d="M32 15.5C32 24.0604 20.7075 36 16 36C11.2925 36 0 24.0604 0 15.5C0 6.93959 7.16344 0 16 0C24.8366 0 32 6.93959 32 15.5Z"/><path class="bread-marker__item-content" fill-rule="evenodd" clip-rule="evenodd" d="M20.5167 10.5632C21.0538 11.1735 21.4564 12.3466 21.3061 13.1455C21.2693 13.3414 21.25 13.5434 21.25 13.75C21.25 14.8795 21.8261 15.8743 22.7006 16.4568C23.1715 16.7705 23.5041 17.3365 23.2668 17.8502C21.9992 20.5952 19.222 22.5 16 22.5C11.5817 22.5 8 18.9183 8 14.5C8 10.0817 11.5817 6.5 16 6.5C17.2777 6.5 18.4855 6.79955 19.5569 7.33225C20.0982 7.60138 20.138 8.32179 20.03 8.91658C20.0102 9.02537 20 9.13671 20 9.25C20 9.74014 20.1916 10.1937 20.5167 10.5632ZM15.5 11.5C16.0523 11.5 16.5 11.0523 16.5 10.5C16.5 9.94772 16.0523 9.5 15.5 9.5C14.9477 9.5 14.5 9.94772 14.5 10.5C14.5 11.0523 14.9477 11.5 15.5 11.5ZM18 17C18 17.5523 17.5523 18 17 18C16.4477 18 16 17.5523 16 17C16 16.4477 16.4477 16 17 16C17.5523 16 18 16.4477 18 17ZM12 15.5C12.5523 15.5 13 15.0523 13 14.5C13 13.9477 12.5523 13.5 12 13.5C11.4477 13.5 11 13.9477 11 14.5C11 15.0523 11.4477 15.5 12 15.5Z"/></svg>';
const CREAMBREAD_ICON =
  '<svg class="bread-marker__item" viewBox="0 0 32 36" fill="none" xmlns="http://www.w3.org/2000/svg"><path class="bread-marker__item-background" d="M32 15.5C32 24.0604 20.7075 36 16 36C11.2925 36 0 24.0604 0 15.5C0 6.93959 7.16344 0 16 0C24.8366 0 32 6.93959 32 15.5Z"/><path class="bread-marker__item-content" d="M16 8.25C11.03 8.25 7 11.95 7 16.515C7 21.08 11.03 21.75 16 21.75C20.97 21.75 25 21.08 25 16.515C25 11.95 20.97 8.25 16 8.25ZM16 20.4C12.025 20.4 8.8 19.69 8.8 17.7C8.8 15.71 12.025 14.1 16 14.1C19.975 14.1 23.2 15.71 23.2 17.7C23.2 19.69 19.975 20.4 16 20.4Z"/></svg>';
const SNACK_ICON =
  '<svg class="bread-marker__item" viewBox="0 0 32 36" fill="none" xmlns="http://www.w3.org/2000/svg"><path class="bread-marker__item-background" d="M32 15.5C32 24.0604 20.7075 36 16 36C11.2925 36 0 24.0604 0 15.5C0 6.93959 7.16344 0 16 0C24.8366 0 32 6.93959 32 15.5Z" fill="${backgroundColour}"/>`<path class="bread-marker__item-content" fill-rule="evenodd" clip-rule="evenodd" d="M7.75 14.125C7.75 11.0877 10.2127 8.625 13.25 8.625C14.2517 8.625 15.191 8.89289 16 9.36094C16.809 8.89289 17.7483 8.625 18.75 8.625C21.7873 8.625 24.25 11.0877 24.25 14.125C24.25 15.4646 23.7679 16.6949 22.9704 17.6489C22.9549 17.6707 22.9385 17.692 22.9211 17.7127C22.447 18.2778 21.6745 18.787 20.841 19.2173C21.3029 19.2926 21.7927 19.3472 22.3101 19.3809C22.8651 19.4159 23.2801 19.8909 23.2451 20.4409C23.2151 20.9709 22.7751 21.3759 22.2501 21.3759H22.1801C20.4986 21.2679 19.0363 20.9525 17.806 20.4383C17.2385 20.6142 16.6897 20.7567 16.1991 20.855C16.1956 20.8557 16.1922 20.8564 16.1887 20.857C16.063 20.8812 15.9324 20.8813 15.8039 20.8556M17.4345 17.9773C17.595 18.0863 17.7638 18.1892 17.9411 18.2859C18.3165 18.1525 18.6942 18.005 19.0594 17.8471C20.1656 17.3688 20.9848 16.8671 21.3434 16.4788C21.3595 16.4569 21.3765 16.4356 21.3945 16.4149C21.9284 15.7992 22.25 14.9995 22.25 14.125C22.25 12.223 20.7321 10.6749 18.8419 10.6262C18.81 10.6293 18.7777 10.6309 18.7451 10.6309C18.3587 10.6309 17.9867 10.6938 17.6389 10.81C17.7239 10.9224 17.8048 11.0382 17.8812 11.1571C18.434 12.0148 18.755 13.0357 18.755 14.1309C18.755 14.5409 18.71 14.9509 18.62 15.3509C18.3861 16.3438 17.9888 17.2207 17.4345 17.9773ZM14.3611 10.8099C14.0133 10.6938 13.6414 10.6309 13.255 10.6309C13.2224 10.6309 13.1901 10.6293 13.1582 10.6262C11.2679 10.6749 9.75 12.223 9.75 14.125C9.75 14.9995 10.0716 15.7992 10.6055 16.4149L10.6177 16.4292C10.9459 16.8224 11.7858 17.3472 12.9414 17.8472C13.3063 18.0051 13.6838 18.1525 14.059 18.2859C14.2363 18.1892 14.4051 18.0863 14.5656 17.9773C14.0113 17.2207 13.614 16.3438 13.3801 15.3509C13.2901 14.9509 13.2451 14.5409 13.2451 14.1309C13.2451 13.0549 13.5549 12.0505 14.0901 11.2023C14.1749 11.0674 14.2653 10.9365 14.3611 10.8099ZM16.0001 11.9618C15.9085 12.0773 15.8242 12.1988 15.7476 12.3255C15.4317 12.8513 15.25 13.467 15.25 14.125C15.25 14.9428 15.5295 15.6924 16 16.2862C16.4705 15.6924 16.75 14.9428 16.75 14.125C16.75 13.4553 16.5618 12.8294 16.2354 12.2974C16.1634 12.1808 16.0848 12.0688 16.0001 11.9618Z"/><path class="bread-marker__item-content" d="M15.8009 20.855C15.3104 20.7567 14.7616 20.6142 14.1941 20.4383C12.9638 20.9525 11.5015 21.2679 9.81999 21.3759H9.74999C9.22499 21.3759 8.78499 20.9709 8.75499 20.4409C8.71999 19.8909 9.13499 19.4159 9.68999 19.3809C10.2078 19.3472 10.6978 19.2926 11.16 19.2171C10.3307 18.7886 9.56178 18.2815 9.08861 17.7183C8.25599 16.7549 7.75 15.4973 7.75 14.125"/></svg>';
const NOSTALGIC_BREAD_ICON =
  '<svg class="bread-marker__item" viewBox="0 0 32 36" fill="none" xmlns="http://www.w3.org/2000/svg"><path class="bread-marker__item-background" d="M32 15.5C32 24.0604 20.7075 36 16 36C11.2925 36 0 24.0604 0 15.5C0 6.93959 7.16344 0 16 0C24.8366 0 32 6.93959 32 15.5Z"/><path class="bread-marker__item-content" fill-rule="evenodd" clip-rule="evenodd" d="M15.8569 10.6973C15.8612 10.7466 15.8585 10.7965 15.8558 10.8464C16.1094 10.8242 16.3559 10.8027 16.5999 10.792C16.7766 10.7836 16.9571 10.7785 17.1377 10.7733L17.2444 10.7693C17.6427 10.7543 18.0565 10.7388 18.5573 10.6917C19.0644 10.6473 19.3816 10.3782 19.5787 10.0345C19.6836 9.85495 19.9124 9.79235 20.0881 9.89409C20.2676 9.99905 20.3302 10.2278 20.2285 10.4035C19.9297 10.923 19.4109 11.3623 18.622 11.4313C18.0584 11.4806 17.5808 11.4976 17.1454 11.5108C17.0529 11.5152 16.9632 11.5184 16.8744 11.5215L16.8743 11.5215L16.8743 11.5215C16.7935 11.5243 16.7134 11.5272 16.6326 11.5309C16.0531 11.5603 15.4896 11.6096 14.7611 11.762C14.7541 11.7626 14.7461 11.7624 14.7381 11.7623C14.7301 11.7621 14.7221 11.7619 14.7151 11.7625C13.9712 11.9411 13.4727 12.2474 13.1335 12.5894C12.7449 12.9747 12.5032 13.4572 12.3652 13.9484C12.2505 14.3418 12.2031 14.7328 12.193 15.0637C12.2601 15.0614 12.3341 15.0584 12.4082 15.0555L12.4088 15.0555C12.7325 15.0473 13.1161 15.0338 13.5355 15.0191L13.8385 15.0085C14.6716 14.9569 15.5654 14.9106 16.4176 14.8751L16.7902 14.8744C18.2418 14.7936 19.5782 14.6944 20.2815 14.5796C21.4537 14.3884 22.3059 13.785 23.0034 12.9538C24.4432 11.2379 24.2195 8.68087 22.5036 7.24103C20.7876 5.80118 18.2306 6.02489 16.7907 7.74083C16.0785 8.60523 15.7702 9.66498 15.8569 10.6973ZM14.6701 22.8945L14.6026 22.975L14.6026 22.975C14.5447 23.0439 14.4676 23.1359 14.3885 23.2457C14.2188 23.4557 14.0356 23.6741 13.9379 23.7749L13.9219 23.794C13.1987 24.6558 11.9064 24.7724 11.0408 24.0461C10.562 23.6443 10.3239 23.0725 10.3194 22.4944C10.738 22.33 11.1192 22.0624 11.4278 21.6947C11.6463 21.4343 11.806 21.1505 11.9076 20.8506C11.9101 20.8442 11.9128 20.8391 11.9152 20.8345C11.9183 20.8286 11.9209 20.8235 11.9224 20.8174C11.9753 20.6921 12.0494 20.565 12.115 20.4634C12.1459 20.411 12.171 20.3733 12.1935 20.3465L12.2192 20.3159L12.2257 20.3082C12.3594 20.1332 12.5442 20.0142 12.7563 19.9637C12.8152 19.9479 12.8748 19.9391 12.9523 19.9323C13.507 19.8838 13.9216 19.8763 14.3136 19.8692H14.3136L14.3769 19.868H14.377C14.5082 19.8672 14.6394 19.8663 14.7668 19.8623C15.0997 19.8545 15.4385 19.8319 15.8279 19.7801C15.8275 19.7961 15.8282 19.8147 15.829 19.8333C15.8297 19.8518 15.8304 19.8704 15.8301 19.8864L15.8307 19.8934C15.8459 21.081 15.3997 22.0251 14.7022 22.8562L14.6958 22.8639L14.6701 22.8945ZM16.4677 18.8997C15.7431 19.0554 15.2494 19.0915 14.743 19.1038C14.6226 19.1073 14.5023 19.1107 14.3781 19.1109C13.9632 19.1153 13.499 19.1239 12.8862 19.1776C12.7876 19.1862 12.6896 19.2019 12.5851 19.2252C12.1918 19.3128 11.8639 19.5403 11.6311 19.841L11.6279 19.8448L11.6182 19.8563C11.6156 19.8672 11.6028 19.8825 11.5899 19.8978C11.5642 19.9285 11.5263 19.9815 11.4889 20.0415C11.4162 20.1437 11.3332 20.2894 11.2584 20.4486C11.2397 20.4786 11.221 20.5086 11.2132 20.5412C11.1382 20.7785 11.019 20.9983 10.8519 21.1975C10.1287 22.0593 8.83643 22.1759 7.9708 21.4495C7.109 20.7264 6.99239 19.4341 7.71874 18.5685L7.73481 18.5493C7.82097 18.4389 8.00355 18.2135 8.17772 18.0137C8.22333 17.9594 8.26817 17.9082 8.30889 17.8618C8.34278 17.8232 8.37382 17.7878 8.4001 17.7565L8.46759 17.676L8.4933 17.6454L8.49973 17.6377C9.19715 16.8066 10.0494 16.2032 11.2216 16.0119C12.2048 15.8514 14.419 15.7251 16.4589 15.6354C17.4629 15.5901 18.4041 15.5574 19.0943 15.5361C19.1646 15.5363 19.2319 15.534 19.2937 15.5318C19.3005 15.5316 19.3072 15.5313 19.3139 15.5311C19.3038 15.862 19.2564 16.253 19.1417 16.6463C18.9967 17.1382 18.7614 17.613 18.3708 18.0163C17.9918 18.3902 17.3831 18.7344 16.4818 18.8985C16.478 18.8953 16.4748 18.8991 16.4748 18.8991C16.4709 18.8959 16.4677 18.8997 16.4677 18.8997Z"/></svg>';
const ETC_BREAD_ICON =
  '<svg class="bread-marker__item" viewBox="0 0 32 36" fill="none" xmlns="http://www.w3.org/2000/svg"><path class="bread-marker__item-content" d="M32 15.5C32 24.0604 20.7075 36 16 36C11.2925 36 0 24.0604 0 15.5C0 6.93959 7.16344 0 16 0C24.8366 0 32 6.93959 32 15.5Z"/><path class="bread-marker__item-content" d="M16.0005 4.63477C13.7905 4.63477 12.0005 6.42477 12.0005 8.63477V16.1348C12.0005 18.1298 13.4655 19.7798 15.3755 20.0798L15.3755 24.7398C15.3755 25.0848 15.6555 25.3648 16.0005 25.3648C16.3455 25.3648 16.6255 25.0848 16.6255 24.7398V20.0798C18.5355 19.7798 20.0005 18.1298 20.0005 16.1348V8.63477C20.0005 6.42477 18.2105 4.63477 16.0005 4.63477ZM16.3205 10.2298C16.6055 10.4648 17.0305 10.8198 17.0305 11.4998C17.0305 12.1798 16.6005 12.5298 16.3205 12.7698C16.0555 12.9898 15.9705 13.0798 15.9705 13.2698C15.9705 13.4648 16.0555 13.5498 16.3205 13.7698C16.6055 14.0048 17.0305 14.3598 17.0305 15.0398C17.0305 15.7198 16.6005 16.0748 16.3205 16.3098C16.0555 16.5298 15.9705 16.6198 15.9705 16.8098C15.9705 17.0848 15.7455 17.3098 15.4705 17.3098C15.1955 17.3098 14.9705 17.0848 14.9705 16.8098C14.9705 16.1348 15.4005 15.7748 15.6805 15.5398C15.9455 15.3198 16.0305 15.2298 16.0305 15.0398C16.0305 14.8498 15.9455 14.7598 15.6805 14.5398C15.3955 14.3048 14.9705 13.9448 14.9705 13.2698C14.9705 12.5948 15.4005 12.2398 15.6805 11.9998C15.9455 11.7798 16.0305 11.6898 16.0305 11.4998C16.0305 11.3098 15.9455 11.2198 15.6805 10.9998C15.3955 10.7648 14.9705 10.4098 14.9705 9.72977C14.9705 9.04977 15.4005 8.69977 15.6805 8.45977C15.9455 8.23977 16.0305 8.14977 16.0305 7.95977C16.0305 7.68477 16.2555 7.45977 16.5305 7.45977C16.8055 7.45977 17.0305 7.68477 17.0305 7.95977C17.0305 8.63477 16.6005 8.98977 16.3205 9.22977C16.0555 9.44977 15.9705 9.53977 15.9705 9.72977C15.9705 9.91977 16.0555 10.0098 16.3205 10.2298Z"/></svg>';

interface MarkerSize {
  width: number;
  height: number;
}

const SMALL_MARKER_SIZE: MarkerSize = {
  width: 16,
  height: 18,
};

const MEDIUM_MARKER_SIZE: MarkerSize = {
  width: 24,
  height: 27,
};

const LARGE_MARKER_SIZE: MarkerSize = {
  width: 32,
  height: 36,
};

type Flag = 'default' | 'filtered' | 'wished' | 'flaged';

type Size = 'small' | 'medium' | 'large';

const wrapMarker = (elementStr: string, type: Flag, size: Size) =>
  `<div class="bread-marker" data-type="${type}" data-size="${size}">${elementStr}</div>`;

const breadRecord: Record<Bread, string> = {
  기본: DEFAULT_BREAD_ICON,
  식사빵: MEAL_BREAD_ICON,
  '비건/키토': BEGAN_KITO_ICON,
  크로와상: CROISSANT_ICON,
  구움과자류: BAKEDBREAD_ICON,
  케이크: CAKE_ICON,
  '파이/타르트': PIE_TART_ICON,
  마카롱: MACARON_ICON,
  도넛: DOCUT_ICON,
  쿠키: COOKIE_ICON,
  크림빵: CREAMBREAD_ICON,
  과자류: SNACK_ICON,
  추억의빵: NOSTALGIC_BREAD_ICON,
  기타: ETC_BREAD_ICON,
};

const sizeRecord: Record<Size, MarkerSize> = {
  small: SMALL_MARKER_SIZE,
  medium: MEDIUM_MARKER_SIZE,
  large: LARGE_MARKER_SIZE,
};

interface MarkerItem {
  entity: BakeryEntity;
  marker: naver.maps.Marker;
}

interface BakeryMarkersProps {
  entities: BakeryEntity[] | undefined;
}

const BakeryMarkers: React.FC<BakeryMarkersProps> = ({
  entities,
}) => {
  const markerItems = React.useRef<MarkerItem[]>([]);
  const activeMarkerItem = React.useRef<MarkerItem | null>(null);

  const naverMap = useNaverMap();

  const [, setBottomSheetType] = useAtom(bottomSheetTypeAtom);
  const [currentBakeryId, setCurrentBakeryId] = useAtom(currentBakeryIdAtom);
  const [bottomSheetRef] = useAtom(bottomSheetRefAtom);
  const [currentFilter] = useAtom(currentFilterAtom);

  const clearMarkers = React.useCallback(
    () => {
      markerItems.current.forEach(({ marker }) => {
        marker.setMap(null);
        marker.clearListeners('click');
      });

      markerItems.current = [];
    },
    [],
  );

  const initializedMarkers = React.useCallback(
    () => {
      if (entities === undefined) return;
      if (naverMap === undefined) return;

      const sdk = getNavermapSDK();
      if (sdk === undefined) return;

      clearMarkers();

      entities.forEach((entity) => {
        const marker = new sdk.Marker({
          position: {
            lat: entity.latitude,
            lng: entity.longitude,
          },
          map: naverMap,
          icon: {
            content: wrapMarker(breadRecord['기본'], 'default', 'small'),
            size: sizeRecord.small,
          }
        });

        sdk.Event.addListener(marker, 'click', (e) => {
          const markerEl = e.overlay.get('eventTarget');
          if (!(markerEl instanceof HTMLElement)) return;

          setCurrentBakeryId(entity.bakeryId);
        });

        markerItems.current.push({ entity, marker });
      });
    },
    [entities, naverMap, clearMarkers, setCurrentBakeryId],
  );

  React.useEffect(() => {
    if (currentFilter.length === 0) {
      initializedMarkers();
      return;
    }

    const filteredMarkerItems = markerItems.current.reduce<MarkerItem[]>((acc, item) => {
      let filtered = false;

      for (const filterKey of currentFilter) {
        if (item.entity.breadCategoryList.includes(filterKey)) {
          filtered = true;
        }
      }

      if (filtered) {
        acc.push(item);
      } else {
        item.marker.setMap(null);
      }

      return acc;
    }, []);

    for (const filteredItem of filteredMarkerItems) {
      const markerEl = filteredItem.marker.get('eventTarget');

      if (!(markerEl instanceof HTMLElement)) continue;

      for (const filterKey of currentFilter) {
        if (filteredItem.entity.breadCategoryList.includes(filterKey)) {
          filteredItem.marker.setIcon({
            content: wrapMarker(breadRecord[filterKey], 'default', 'medium'),
            size: sizeRecord.medium,
          });
        }
      }
    }

    markerItems.current = filteredMarkerItems;
  }, [currentFilter, initializedMarkers]);

  React.useEffect(() => {
    const currentItem = markerItems.current.find(({ entity }) => entity.bakeryId === currentBakeryId);
    if (currentItem === undefined) return;

    const { marker } = currentItem;
    const markerEl = marker.get('eventTarget');

    if (!(markerEl instanceof HTMLElement)) return;

    markerEl.setAttribute('data-size', 'large');

    if (activeMarkerItem.current !== null) {
      const activeMarkerEl = activeMarkerItem.current.marker.get('eventTarget');

      if (activeMarkerEl instanceof HTMLElement) {
        activeMarkerEl.setAttribute('data-size', 'small');
      }
    }

    activeMarkerItem.current = currentItem;
    bottomSheetRef?.snapTo(({ snapPoints }) => snapPoints[1]);
    setBottomSheetType('single');
  }, [currentBakeryId, bottomSheetRef, setBottomSheetType]);

  React.useEffect(() => {
    const sdk = getNavermapSDK();
    if (sdk === undefined) return;

    initializedMarkers();

    return () => {
      markerItems.current.forEach((item) => {
        item.marker.setMap(null);
      });

      markerItems.current = [];
    };
  }, [initializedMarkers]);

  return null;
};

export default BakeryMarkers;
